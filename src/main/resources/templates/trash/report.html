<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>ì“°ë ˆê¸° í•´ê²° â€¢ Kakao Map (ì¶˜ì²œ)</title>

    <!-- Live Serverì¼ ë•Œ -->
    <script src="/js/config.local.js"></script>
    <link rel="stylesheet" th:href="@{/nav.css}" />
    <link rel="stylesheet" th:href="@{/home/home.css}" />
    <!-- Spring Bootë¡œ êµ¬ë™ ì‹œ â†‘ë¥¼ /js/config.local.js ë¡œ ë°”ê¾¸ì„¸ìš” -->

    <!-- Kakao SDK ë™ì  ë¡œë” (í•œ ë²ˆë§Œ ì´ˆê¸°í™”) -->
    <script>
        (function loadKakao() {
            if (!window.APP_KEY) { console.error("APP_KEY ì—†ìŒ. config.local.js í™•ì¸"); return; }
            var s = document.createElement("script");
            s.src = "https://dapi.kakao.com/v2/maps/sdk.js?appkey=" + encodeURIComponent(window.APP_KEY) + "&libraries=services&autoload=false";
            s.async = true;
            s.onload = function(){ kakao.maps.load(initApp); };
            document.head.appendChild(s);

            window.userAddress = null;

            function initApp(){
                var run = function(){
                    // ì§€ë„
                    var mapEl = document.getElementById("map");
                    var map = new kakao.maps.Map(mapEl, { center:new kakao.maps.LatLng(37.8813,127.73), level:5 });
                    bindMap(map);

                    /**/
                    // âœ… í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° + ì£¼ì†Œ ë³€í™˜
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function(position) {
                            var lat = position.coords.latitude;
                            var lng = position.coords.longitude;

                            var geocoder = new kakao.maps.services.Geocoder();
                            geocoder.coord2Address(lng, lat, function(result, status) {
                                if (status === kakao.maps.services.Status.OK) {
                                    if (result[0].road_address) {
                                    }
                                    window.userAddress = result[0].address.address_name;
                                }
                            });
                        });
                    }
                    /**/

                    // ëª©ë¡
                    renderListResponsive();
                    enableSwipeIfMobile();

                    // ë¦¬ì‚¬ì´ì¦ˆ
                    var lastMobile = isMobile();
                    window.addEventListener("resize", function(){
                        var nowMobile = isMobile();
                        if(nowMobile!==lastMobile){ lastMobile=nowMobile; renderListResponsive(); enableSwipeIfMobile(); }
                        else if(!nowMobile){ renderListWeb(currentPage); }
                    });
                };
                if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", run); else run();
            }
        })();
    </script>

    <style>
        :root { --line:#e5e7eb; --bg:#f6f7f9; --card:#fff; --danger:#ff1f43; --ink:#222; --muted:#6b7280; }
        html,body{height:100%;margin:0;font-family:"Noto Sans KR",system-ui,sans-serif;background:var(--bg);color:var(--ink)}
        .container{height:100%;display:flex;flex-direction:column}
        .map-wrap{flex:1;position:relative}
        #map{position:absolute;inset:0}

        /* FAB (ì‹ ê³  ì „ìš©) */
        .fab{position:fixed;right:16px;top:70px;z-index:9999;width:56px;height:56px;border-radius:50%;
            background:var(--danger);display:flex;align-items:center;justify-content:center;color:#fff;border:0;cursor:pointer;
            box-shadow:0 8px 18px rgba(0,0,0,.25)}
        .fab svg{width:28px;height:28px}

        /* ëª©ë¡ ê³µí†µ */
        .list{background:#fff;border-top:1px solid var(--line);overflow:auto}
        .item{padding:12px;border-bottom:1px solid var(--line);cursor:pointer}
        .item:hover{background:#fafafa}
        .title{font-weight:600}
        .addr{font-size:12px;color:#666}
        .pagination{display:flex;justify-content:center;gap:6px;padding:8px}
        .pagination button{border:1px solid var(--line);background:#fff;padding:4px 8px;border-radius:4px;cursor:pointer}
        .pagination button.active{background:#333;color:#fff}

        /* ëª¨ë°”ì¼: ë°”í…€ì‹œíŠ¸(ìŠ¤ì™€ì´í”„) */
        @media (max-width: 767px){
            .list{
                position:fixed;left:0;right:0;bottom:0;z-index:9998;max-height:80vh;height:50vh;border-radius:16px 16px 0 0;
                box-shadow:0 -12px 20px rgba(0,0,0,.12);transform:translateY(70%);transition:transform .25s ease;
                touch-action:none;will-change:transform;user-select:none;
            }
            .list.open{transform:translateY(0)}
            .handle{width:44px;height:5px;border-radius:999px;background:#d1d5db;margin:10px auto 6px;cursor:grab}
            .pagination{display:none}
        }
        /* ë°ìŠ¤í¬í†±: ê³ ì • ëª©ë¡ */
        @media (min-width: 768px){
            .list{position:static;transform:none!important;height:clamp(220px, 32vh, 560px);max-height:none}
            .handle{display:none}
        }

        /* ====== ìƒì„¸ ëª¨ë‹¬ ====== */
        .modal{position:fixed;inset:0;z-index:12000;display:none}
        .modal.open{display:block}
        .modal .overlay{position:absolute;inset:0;background:rgba(0,0,0,.45)}
        .modal .sheet{
            position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
            width:min(640px, 92vw);max-height:86vh;overflow:auto;background:#fff;border-radius:18px;
            box-shadow:0 24px 60px rgba(0,0,0,.25)
        }
        .m-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line);gap:8px}
        .m-head-right{display:flex;gap:8px;align-items:center}
        .points{font-weight:800;font-size:18px;background:#ffe8ec;color:#b91c1c;border-radius:999px;padding:6px 12px;display:inline-flex;align-items:center;gap:6px}
        .points.disabled{background:#f3f4f6;color:#9ca3af;filter:grayscale(1)}
        .title-row{display:flex;align-items:center;gap:8px;font-weight:800}
        .pill-done{font-size:12px;color:#065f46;background:#d1fae5;border:1px solid #a7f3d0;border-radius:999px;padding:3px 8px}
        .close{border:0;background:#f3f4f6;border-radius:10px;width:36px;height:36px;cursor:pointer}
        .solve-btn{border:1px solid #111;background:#111;color:#fff;border-radius:10px;height:36px;padding:0 12px;cursor:pointer;font-weight:700}
        .m-body{padding:10px 16px 18px}
        .section{margin-top:10px}
        .label{font-weight:700;margin:10px 0 6px}
        .photo{width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:12px;border:1px solid var(--line);background:#f8fafc}
        .comment{color:#374151;margin-top:6px;line-height:1.5}
        .meta{color:var(--muted);font-size:12px;margin-top:4px}

        /* ====== ì•¡ì…˜ ëª¨ë‹¬(ì‹ ê³ /í•´ê²° ì „ìš© ëª¨ë“œ) ====== */
        .action-modal{position:fixed;inset:0;z-index:13000;display:none}
        .action-modal.open{display:block}
        .action-modal .overlay{position:absolute;inset:0;background:rgba(0,0,0,.45)}
        .action-modal .sheet{
            position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
            width:min(560px, 92vw);max-height:86vh;overflow:auto;background:#fff;border-radius:18px;
            box-shadow:0 24px 60px rgba(0,0,0,.25)
        }
        .a-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
        .a-title{font-weight:800}
        .a-body{padding:12px 14px 16px}
        .field{display:grid;gap:6px;margin:12px 0}
        .field label{font-weight:700}
        .uploader{display:grid;gap:10px}
        .preview{width:100%;aspect-ratio:16/9;border:1px dashed #cbd5e1;border-radius:12px;display:grid;place-items:center;overflow:hidden;background:#f8fafc}
        .preview img{width:100%;height:100%;object-fit:cover}
        .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
        .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
        .btn.primary{background:#111;color:#fff;border-color:#111}
    </style>


    <style>
        .page-title {
            margin: 32px auto 24px;
            text-align: center;
            font-size: 28px;         /* í¬ê¸° í¬ê²Œ */
            font-weight: 800;        /* ë‘ê»ê²Œ */
            color: var(--primary);   /* ë„¤ë¹„ë‘ ë§ì¶˜ í¬ì¸íŠ¸ ì»¬ëŸ¬ */
            letter-spacing: 0.5px;
            line-height: 1.3;
            position: relative;
        }

        .page-title::after {
            content: "";
            display: block;
            width: 60px;
            height: 3px;
            background: var(--primary);
            border-radius: 3px;
            margin: 12px auto 0;    /* ê°€ìš´ë° ë°‘ì¤„ */
        }
    </style>

</head>
<body>
<!-- ìƒë‹¨ ê³µí†µ ë„¤ë¹„ (nav.css ìŠ¤íƒ€ì¼ ì‚¬ìš©) -->
<header class="site-header">
    <div class="inner">
        <!-- ì¢Œ: ë¸Œëœë“œ -->
        <a class="brand" href="/user">ì¶˜ì²œì§€ì¼œë´„</a>

        <!-- ê°€ìš´ë°: ë©”ë‰´ -->
        <nav class="nav-links">
            <a class="nav-link" href="/trash/reportPage"
               th:classappend="${#httpServletRequest != null and #httpServletRequest.requestURI.matches('.*/trash/reportPage.*')} ? ' active' : ''">
                ì§€ë„
            </a>
            <a class="nav-link" href="/personal/missionPage"
               th:classappend="${#httpServletRequest != null and #httpServletRequest.requestURI.matches('.*/personal/.*')} ? ' active' : ''">
                ì°¸ì—¬
            </a>
            <a class="nav-link" href="/center"
               th:classappend="${#httpServletRequest != null and #httpServletRequest.requestURI.matches('.*/center.*')} ? ' active' : ''">
                ì„¼í„°
            </a>
            <a class="nav-link" href="/info"
               th:classappend="${#httpServletRequest != null and #httpServletRequest.requestURI.matches('.*/info.*')} ? ' active' : ''">
                ì •ë³´
            </a>
        </nav>

        <!-- ìš°: ë¡œê·¸ì¸/ì‚¬ìš©ì -->
        <div class="auth">
            <!-- ë¡œê·¸ì¸ ì „ -->
            <a class="btn" th:if="${#strings.isEmpty(session.user_id)}" th:href="@{/user/login}">ë¡œê·¸ì¸</a>

            <!-- ë¡œê·¸ì¸ í›„ -->
            <div th:unless="${#strings.isEmpty(session.user_id)}" style="display:flex; gap:8px;">
                <a class="btn" th:href="@{/user/myPage}">ë‚´ ì •ë³´</a>
                <a class="btn primary" th:href="@{/user/logOut}">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
        </div>
    </div>
</header>

<!-- (ì˜µì…˜) ëª¨ë°”ì¼ í•˜ë‹¨ ë„¤ë¹„ -->
<nav class="bottom-nav" aria-label="í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜">
    <div class="bn-inner">
        <a class="bn-item" href="/trash/reportPage">
            <span class="ic">ğŸ“</span><span>ì§€ë„</span>
        </a>
        <a class="bn-item" href="/personal/missionPage">
            <span class="ic">ğŸ¯</span><span>ì°¸ì—¬</span>
        </a>
        <a class="bn-item" href="/center">
            <span class="ic">ğŸ›ï¸</span><span>ì„¼í„°</span>
        </a>
        <a class="bn-item" th:href="${#strings.isEmpty(session.user_id)} ? @{/user/login} : @{/user/myPage}">
            <span class="ic">â„¹ï¸</span>
            <span th:text="${#strings.isEmpty(session.user_id)} ? 'ë¡œê·¸ì¸' : 'ì •ë³´'">ì •ë³´</span>
        </a>
    </div>
</nav>

<!---->
<h1 class="page-title">ì“°ë ˆê¸° í•´ê²°</h1>
<div class="container">
    <div class="map-wrap"><div id="map"></div></div>

    <!-- ëª©ë¡ -->
    <div class="list" id="listPanel" aria-label="ì‹ ê³ /í•´ê²° ëª©ë¡">
        <div class="handle" aria-hidden="true"></div>
        <div id="listContent"></div>
        <div class="pagination" id="pagination"></div>
    </div>
</div>

<!-- ìš°ìƒë‹¨ ì‚¬ì´ë Œ ë²„íŠ¼ (ì‹ ê³  ì „ìš©) -->
<button class="fab" id="fab" aria-label="ì‹ ê³ í•˜ê¸°" th:unless="${#strings.isEmpty(session.user_id)}">
    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M7 11V9a5 5 0 0 1 10 0v2" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
        <rect x="4" y="11" width="16" height="7" rx="2" fill="rgba(255,255,255,.15)" stroke="#fff" stroke-width="1.6"/>
        <path d="M12 3v2M5.5 5.5l1.5 1.5M18.5 5.5 17 7" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
    </svg>
</button>

<!-- ====== ìƒì„¸ ëª¨ë‹¬ (í•€/ëª©ë¡ í´ë¦­) ====== -->
<div class="modal" id="detailModal" aria-modal="true" role="dialog">
    <div class="overlay" id="modalOverlay"></div>
    <div class="sheet" role="document">
        <div class="m-head">
            <div class="points" id="mPoints" style="color: black;">200p</div>
            <div class="m-head-right">
                <button class="solve-btn" id="solveBtn" th:unless="${#strings.isEmpty(session.user_id)}">í•´ê²°í•˜ê¸°</button>
                <button class="close" id="modalClose" aria-label="ë‹«ê¸°">âœ•</button>
            </div>
        </div>
        <div class="m-body">
            <div class="title-row">
                <div id="mReporter">@@ë‹˜ì˜ ì‹ ê³ </div>
                <div class="pill-done" id="mDone" style="display:none">í•´ê²°ì™„ë£Œ</div>
            </div>
            <div class="meta" id="mAddr"></div>

            <div class="section">
                <div class="label">ì‹ ê³  ì‚¬ì§„</div>
                <img id="mReportImg" class="photo" alt="ì‹ ê³  ì‚¬ì§„">
                <div class="comment" id="mReportComment"></div>
            </div>

            <div class="section" id="resolveSection" style="display:none">
                <div class="label"><span id="mResolver">##ë‹˜ì˜ í•´ê²°</span></div>
                <img id="mResolveImg" class="photo" alt="í•´ê²° ì‚¬ì§„">
                <div class="comment" id="mResolveComment"></div>
            </div>
        </div>
    </div>
</div>

<!-- ====== ì•¡ì…˜ ëª¨ë‹¬ (ëª¨ë“œë³„ ë‹¨ì¼ í¼: ì‹ ê³  OR í•´ê²°) ====== -->
<div class="action-modal" id="actionModal" aria-modal="true" role="dialog">
    <div class="overlay" id="actionOverlay"></div>
    <div class="sheet" role="document">
        <div class="a-head">
            <strong class="a-title" id="actionTitle">ì‹ ê³ í•˜ê¸°</strong>
            <button class="close" id="actionClose" aria-label="ë‹«ê¸°">âœ•</button>
        </div>

        <!-- ì‹ ê³  í¼ -->
        <div class="a-body" id="reportForm">

            <div class="field">
                <label for="reportType">ì œëª©</label>
                <select id="reportType" style="width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="smoke">ë‹´ë°°ê½ì´ˆ/ì‘ì€ì“°ë ˆê¸°</option>
                    <option value="can">ìº”/ë³‘/í”Œë¼ìŠ¤í‹±(ì†ŒëŸ‰)</option>
                    <option value="smallWaste">ì¼ë°˜ìƒí™œì“°ë ˆê¸°(ì†Œí˜•ë´‰íˆ¬)</option>
                    <option value="mixedWaste">í˜¼í•©ì“°ë ˆê¸°(ë´‰íˆ¬ ì™¸)</option>
                    <option value="foodWaste">ìŒì‹ë¬¼ì“°ë ˆê¸° ìœ ì¶œ</option>
                    <option value="illegalFurniture">ë¶ˆë²•íˆ¬ê¸° ê°€êµ¬(ìŠ¤í‹°ì»¤ ì—†ìŒ)</option>
                    <option value="constructionWaste">ê±´ì„¤íê¸°ë¬¼/ëŒ€í˜•íê¸°ë¬¼</option>
                    <option value="hazardous">ìœ„í—˜ë¬¼(ë‚ ì¹´ë¡œìš´ ë¬¼ê±´ ë“±)</option>
                </select>
            </div>

            <div class="field">
                <label for="reportFile">ì‹ ê³  ì‚¬ì§„</label>
                <div class="uploader">
                    <div class="preview" id="reportPreview"><span>ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</span></div>
                    <input id="reportFile" type="file" accept="image/*" capture="environment">
                </div>
            </div>
            <div class="field">
                <label for="description">ì„¤ëª…</label>
                <textarea id="description" rows="4" placeholder="ì˜ˆ) ì„±ì›ì´ˆ ì• ì¢…ëŸ‰ì œ ë´‰íˆ¬ê°€ ì°¢ì–´ì ¸ ìˆë‹¤." style="width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;"></textarea>
            </div>
            <div class="actions">
                <button class="btn" id="reportCancel">ì·¨ì†Œ</button>
                <button class="btn primary" onclick="reportCreate();">ì‹ ê³ í•˜ê¸°</button>
            </div>
        </div>

        <!-- í•´ê²° í¼ -->
        <div class="a-body" id="resolveForm" style="display:none">
            <div class="field">
                <label for="resolveFile">í•´ê²° ì‚¬ì§„</label>
                <div class="uploader">
                    <div class="preview" id="resolvePreview"><span>ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</span></div>
                    <input id="resolveFile" type="file" accept="image/*" capture="environment">
                </div>
            </div>
            <div class="field">
                <label for="resolveDesc">í•´ê²° ë‚´ìš©</label>
                <textarea id="resolveDesc" rows="4" placeholder="ì˜ˆ) ì¢…ëŸ‰ì œ ë´‰íˆ¬ êµ¬ì… í›„ ì¬í¬ì¥." style="width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;"></textarea>
            </div>
            <div class="actions">
                <button class="btn" id="resolveCancel">ì·¨ì†Œ</button>
                <input type="hidden" id="report_id_sibal" value=""/>
                <button class="btn primary" id="resolveSubmit" onclick="solutionCreate();">í•´ê²°í•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>

<!-- EXIF (liteëŠ” ìœ„ì—ì„œ, fullì€ ì•„ë˜ deferë¡œ) -->
<script src="https://cdn.jsdelivr.net/npm/exifr/dist/lite.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exifr/dist/exifr.umd.js" defer></script>

<script th:inline="javascript">
    const data =  [[${rList}]];
    console.log(data);

    /************ ëª©ë¡: ì›¹/ì•± ëŒ€ì‘ ************/
    let currentPage = 1;
    let itemsPerPage = 2;
    const isMobile = () => window.matchMedia('(max-width: 767px)').matches;

    function measureItemHeight(){
        const listContent = document.getElementById('listContent');
        const probe = document.createElement('div');
        probe.className='item'; probe.style.visibility='hidden';
        probe.innerHTML=`<div class="title">ì¸¡ì •</div><div class="addr">ê°€ë‚˜ë‹¤</div>`;
        listContent.appendChild(probe);
        const h = probe.offsetHeight || 64;
        listContent.removeChild(probe);
        return h;
    }
    function computeItemsPerPage(){
        if (isMobile()) return data.length;
        const panel = document.getElementById('listPanel');
        const pagination = document.getElementById('pagination');
        const available = panel.clientHeight - (pagination.offsetHeight||0) - 12;
        const itemH = measureItemHeight();
        return Math.max(1, Math.floor(available / itemH));
    }
    function addListItem(it){
        const div=document.createElement('div');
        div.className='item';
        div.innerHTML=`<div class="title">${it.title}</div><div class="addr">${it.addr}</div>`;
        div.onclick=()=>openDetailModal(it);
        document.getElementById('listContent').appendChild(div);
    }
    function renderListWeb(page=1){
        itemsPerPage = computeItemsPerPage();
        const listContent = document.getElementById('listContent');
        const pagination  = document.getElementById('pagination');
        listContent.innerHTML=""; pagination.innerHTML="";
        const totalPages = Math.max(1, Math.ceil(data.length/itemsPerPage));
        if (page>totalPages) page = totalPages; currentPage = page;
        const start = (currentPage-1)*itemsPerPage;
        const slice = data.slice(start, start+itemsPerPage);
        slice.forEach(addListItem);
        for(let i=1;i<=totalPages;i++){
            const btn=document.createElement('button');
            btn.textContent=i; if(i===currentPage) btn.classList.add('active');
            btn.onclick=()=>renderListWeb(i);
            pagination.appendChild(btn);
        }
    }
    function renderListMobile(){
        const listContent = document.getElementById('listContent');
        const pagination  = document.getElementById('pagination');
        listContent.innerHTML=""; pagination.innerHTML="";
        data.forEach(addListItem);
    }
    function renderListResponsive(){ if (isMobile()) renderListMobile(); else renderListWeb(currentPage); }

    /************ ìƒì„¸ ëª¨ë‹¬(í•€/ëª©ë¡ í´ë¦­) ************/
    const detail = {
        el: document.getElementById('detailModal'),
        points: document.getElementById('mPoints'),
        reporter: document.getElementById('mReporter'),
        done: document.getElementById('mDone'),
        addr: document.getElementById('mAddr'),
        reportImg: document.getElementById('mReportImg'),
        reportComment: document.getElementById('mReportComment'),
        resolveSection: document.getElementById('resolveSection'),
        resolver: document.getElementById('mResolver'),
        resolveImg: document.getElementById('mResolveImg'),
        resolveComment: document.getElementById('mResolveComment'),
        overlay: document.getElementById('modalOverlay'),
        closeBtn: document.getElementById('modalClose'),
        solveBtn: document.getElementById('solveBtn'),
        currentItem: null
    };

    function openDetailModal(item){
        detail.currentItem = item;

        // ìƒë‹¨ í¬ì¸íŠ¸
        detail.points.textContent = `${item.point}p`;
        detail.points.classList.toggle('disabled', !!item.status);

        // ì œëª© / ì£¼ì†Œ
        detail.reporter.textContent = `${item.reporter_id}ë‹˜ì˜ ì‹ ê³ `;
        detail.addr.textContent = item.addr;

        // ì‹ ê³  ì„¹ì…˜ (í•­ìƒ í‘œì‹œ)
        detail.reportImg.src = item.image_url;
        detail.reportImg.alt = `${item.reporter_id} ì‹ ê³  ì‚¬ì§„`;
        detail.reportComment.textContent = item.description || '';

        // í•´ê²° ìƒíƒœ ë¶„ê¸°
        if (item.status === 'true') {
            // í•´ê²°ì™„ë£Œ Pill í‘œì‹œ
            detail.done.style.display = 'inline-flex';
            document.getElementById("solveBtn").style.display = 'none';

            // í•´ê²° ì„¹ì…˜ í‘œì‹œ + ë‚´ìš© ì±„ìš°ê¸°
            detail.resolveSection.style.display = '';
            detail.resolver.textContent = `${item.resolver_id || 'ëˆ„êµ°ê°€'}ë‹˜ì˜ í•´ê²°`;
            detail.resolveImg.src = item.proof_image_url || 'https://picsum.photos/seed/resolve_default/960/540';
            detail.resolveImg.alt = `${item.resolver_id || 'ëˆ„êµ°ê°€'} í•´ê²° ì‚¬ì§„`;
            detail.resolveComment.textContent = item.note || '';
        } else {
            // ë¯¸í•´ê²°
            detail.done.style.display = 'none';
            detail.resolveSection.style.display = 'none';
            document.getElementById("solveBtn").style.display = 'block';
        }

        detail.el.classList.add('open');
        document.documentElement.style.overflow='hidden';
    }

    function closeDetailModal(){
        detail.el.classList.remove('open');
        document.documentElement.style.overflow='';
    }
    detail.overlay.onclick = closeDetailModal;
    detail.closeBtn.onclick = closeDetailModal;

    // ìƒì„¸ ëª¨ë‹¬ ìš°ìƒë‹¨ "í•´ê²°í•˜ê¸°" â†’ í•´ê²° ëª¨ë“œë¡œ ì•¡ì…˜ ëª¨ë‹¬ ì—´ê¸°
    detail.solveBtn.onclick = function(){
        openActionModal('resolve', detail.currentItem);
    };
    window.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeDetailModal(); });

    /************ ì•¡ì…˜ ëª¨ë‹¬ (ì‹ ê³ /í•´ê²° ë‹¨ì¼ ëª¨ë“œ) ************/
    const action = {
        el: document.getElementById('actionModal'),
        overlay: document.getElementById('actionOverlay'),
        closeBtn: document.getElementById('actionClose'),
        title: document.getElementById('actionTitle'),
        // ì‹ ê³ 
        reportForm: document.getElementById('reportForm'),
        reportFile: document.getElementById('reportFile'),
        reportPreview: document.getElementById('reportPreview'),
        // í•´ê²°
        resolveForm: document.getElementById('resolveForm'),
        resolveFile: document.getElementById('resolveFile'),
        resolvePreview: document.getElementById('resolvePreview'),
        resolveDesc: document.getElementById('resolveDesc'),
        resolveSubmit: document.getElementById('resolveSubmit'),
        resolveCancel: document.getElementById('resolveCancel'),
        rewardPoints: 200,
        mode: 'report',
        targetItem: null
    };

    function openActionModal(mode='report', item=null){
        action.mode = mode;
        action.targetItem = item;

        if(mode==='report'){
            action.title.textContent = 'ì‹ ê³ í•˜ê¸°';
            action.reportForm.style.display = '';
            action.resolveForm.style.display = 'none';
            // â˜… report ëª¨ë“œë¡œ ì—´ë¦´ ë• id ì´ˆê¸°í™”
            if (action.resolveIdInput) action.resolveIdInput.value = '';
            // if (action.resolveIdText) action.resolveIdText.textContent = '';
        } else {
            action.title.textContent = 'í•´ê²°í•˜ê¸°';
            action.reportForm.style.display = 'none';
            action.resolveForm.style.display = '';

            // â˜… í´ë¦­í•œ ê²Œì‹œê¸€ì˜ id ì£¼ì… + ì½˜ì†” ì¶œë ¥
            const id = item?.id ?? item?.er_id ?? item?.reportId ?? '';
            if (action.resolveIdInput) action.resolveIdInput.value = id;
            console.log('[resolve-open] report_id:', id, 'item:', item);
            document.getElementById("report_id_sibal").value = item.report_id;
            // if (action.resolveIdText) action.resolveIdText.textContent = id;
        }

        action.el.classList.add('open');
        document.documentElement.style.overflow='hidden';
    }
    function closeActionModal(){
        action.el.classList.remove('open');
        document.documentElement.style.overflow='';
    }
    action.overlay.onclick = closeActionModal;
    action.closeBtn.onclick = closeActionModal;

    // FAB â†’ ì‹ ê³  ëª¨ë‹¬
    document.getElementById('fab').onclick = function(){ openActionModal('report'); };

    // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° (ì‹ ê³  / í•´ê²°)
    function bindPreview(inputEl, previewEl){
        inputEl.addEventListener('change', ()=>{
            const f = inputEl.files && inputEl.files[0];
            if(!f){ previewEl.innerHTML = '<span>ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</span>'; return; }
            const url = URL.createObjectURL(f);
            previewEl.innerHTML = `<img src="${url}" alt="preview">`;
        });
    }
    bindPreview(action.reportFile, action.reportPreview);
    bindPreview(action.resolveFile, action.resolvePreview);

    // ì œì¶œ
    action.reportCancel.onclick = closeActionModal;


    action.resolveSubmit.onclick = async () => {
        const file = action.resolveFile?.files?.[0];
        const desc = (action.resolveDesc?.value || '').trim();
        const reportId = action.resolveIdInput?.value || (action.targetItem?.id ?? '');

        console.log('[resolve-submit] report_id:', reportId); // â† í™•ì¸ìš© ë¡œê·¸

        if (!reportId) { alert('ëŒ€ìƒ ì‹ ê³  IDê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
        if (!file)     { alert('í•´ê²° ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

        // ì„œë²„ë¡œ ë³´ë‚¼ ê²½ìš° ì˜ˆì‹œ(FormData)

        const fd = new FormData();
        fd.append('report_id', reportId);
        fd.append('description', desc);
        fd.append('image_url', file);

        const headers = {};
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
        const csrfToken  = document.querySelector('meta[name="_csrf"]')?.content;
        if (csrfHeader && csrfToken) headers[csrfHeader] = csrfToken;

        try {
            const res = await fetch('/trash/resolveCreate', { method:'POST', body:fd, headers });
            if (!res.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜: ' + res.status);
            alert('í•´ê²°ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeActionModal();
        } catch (e) {
            console.error(e);
            alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (e?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }


        // ë°ëª¨ìš©
        alert(action.rewardPoints + 'pë¥¼ ë°›ìœ¼ì…¨ìŠµë‹ˆë‹¤.');
        closeActionModal();
    };
    action.resolveCancel.onclick = closeActionModal;

    /************ ë°”í…€ì‹œíŠ¸ ìŠ¤ì™€ì´í”„(ì•±ì—ì„œë§Œ) ************/
    var detachSwipe = null;
    function enableSwipeIfMobile(){
        const listPanel = document.getElementById('listPanel');
        const handle    = listPanel.querySelector('.handle');
        if (typeof detachSwipe === 'function') { detachSwipe(); }detachSwipe = null;
        if (!isMobile()){ listPanel.style.transform=''; listPanel.classList.remove('open'); return; }
        let basePercent = 70;
        setTranslate(basePercent);
        let dragging=false, startY=0;
        function setTranslate(p){ listPanel.style.transform=`translateY(${p}%)`; }
        function curPercent(){ const m=/translateY\(([-\d.]+)%\)/.exec(listPanel.style.transform); return m?parseFloat(m[1]):basePercent; }
        function down(e){ dragging=true; startY=e.clientY ?? (e.touches && e.touches[0].clientY) ?? 0; listPanel.style.transition='none'; e.target.setPointerCapture?.(e.pointerId); }
        function move(e){ if(!dragging) return; const y=e.clientY ?? (e.touches && e.touches[0].clientY) ?? 0; const dy=y-startY; const dp=(dy/window.innerHeight)*100; let next=Math.max(0, Math.min(70, basePercent+dp)); setTranslate(next); e.preventDefault?.(); }
        function up(){ if(!dragging) return; dragging=false; listPanel.style.transition='transform .25s ease'; const c=curPercent(); if(c>40){ basePercent=70; listPanel.classList.remove('open'); } else { basePercent=0; listPanel.classList.add('open'); } setTranslate(basePercent); }
        const target = handle || listPanel;
        target.style.touchAction='none';
        target.addEventListener('pointerdown',down,{passive:false});
        window.addEventListener('pointermove',move,{passive:false});
        window.addEventListener('pointerup',up,{passive:true});
        window.addEventListener('pointercancel',up,{passive:true});
        detachSwipe=()=>{ target.removeEventListener('pointerdown',down); window.removeEventListener('pointermove',move); window.removeEventListener('pointerup',up); window.removeEventListener('pointercancel',up); listPanel.style.transition=''; };
    }

    /************ ì§€ë„ ë§ˆì»¤ ë°”ì¸ë”© ************/
    function bindMap(map){
        data.forEach((it)=>{
            // ê¸°ë³¸ ì•„ì´ì½˜
            const normalIcon = new kakao.maps.MarkerImage(
                "/img/red_marker.png",
                new kakao.maps.Size(40, 42),
                { offset: new kakao.maps.Point(13, 39) }
            );

            // íšŒìƒ‰ ì•„ì´ì½˜ (ì§ì ‘ ë§Œë“  PNGë¥¼ ì“°ê±°ë‚˜, Kakao ê¸°ë³¸ íšŒìƒ‰ ë§ˆì»¤ ì´ë¯¸ì§€ í™œìš©)
            const grayIcon = new kakao.maps.MarkerImage(
                "/img/gray_marker.png",
                new kakao.maps.Size(40, 42),
                { offset: new kakao.maps.Point(13, 39) }
            );

            const marker = new kakao.maps.Marker({
                position:new kakao.maps.LatLng(it.lat, it.lng),
                map,
                title: it.title,
                image: (it.status === 'true') ? grayIcon : normalIcon  // âœ… í•´ê²°ì™„ë£Œë©´ íšŒìƒ‰
            });

            kakao.maps.event.addListener(marker, 'click', () => openDetailModal(it));
        });
    }
</script>

<!-- í•„ìš”í•˜ë©´ CSRF ë©”íƒ€ê°€ ì´ë¯¸ í˜ì´ì§€ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤ -->
<!-- <meta name="_csrf_header" content="X-CSRF-TOKEN">
<meta name="_csrf"        content="..."> -->
<script>
    // ìœ„ì¹˜ ì¶”ì (ì„ íƒ): ì‹ ê³  ì‹œ ìœ„ì¹˜ í¬í•¨
    let LAT = null;
    let LON = null;
    let LAST_TS = null;

    function success({ coords, timestamp }) {
        LAT = coords.latitude;
        LON = coords.longitude;
        LAST_TS = timestamp;
        console.log('ì—…ë°ì´íŠ¸:', LAT, LON, 'ts=', LAST_TS);
    }
    function error(err) { console.warn('geo fail', err); }

    function getUserLocation() {
        if (!navigator.geolocation) {
            alert('ìœ„ì¹˜ ì •ë³´ê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            return;
        }
        window._watchId = navigator.geolocation.watchPosition(
            success, error, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
    }
    function stopWatch() {
        if (window._watchId != null) {
            navigator.geolocation.clearWatch(window._watchId);
            window._watchId = null;
        }
    }
    getUserLocation();

    function getGeoOnce(opts = { enableHighAccuracy:true, timeout:15000, maximumAge:0 }) {
        return new Promise((resolve, reject) =>
            navigator.geolocation.getCurrentPosition(resolve, reject, opts)
        );
    }

    async function reportCreate() {
        const descriptionEl = document.getElementById('description');
        const fileInput     = document.getElementById('reportFile');
        const file          = fileInput?.files?.[0];
        if (!file) { alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
        const description = (descriptionEl?.value || '').trim();
        const title = document.getElementById("reportType").options[document.getElementById("reportType").selectedIndex].text;


        console.log("ë§ˆì§€ë§‰ í™•ì¸ : " + window.userAddress);
        const fd = new FormData();
        fd.append('description', description);
        fd.append('image_url', file);
        fd.append('latitude',  LAT);
        fd.append('longitude', LON);
        fd.append('title', title);
        fd.append('addr', window.userAddress);

        const headers = {};
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
        const csrfToken  = document.querySelector('meta[name="_csrf"]')?.content;
        if (csrfHeader && csrfToken) headers[csrfHeader] = csrfToken;

        const res = await fetch('/trash/reportCreate', { method:'POST', body:fd, headers });
        if (!res.ok) throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${res.status}`);
        alert('ì‹ ê³ ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        window.location.href = '/trash/reportPage';
    }
    window.reportCreate = reportCreate;
</script>


<script th:inline="javascript">
    async function solutionCreate() {
        var report_id = document.getElementById("report_id_sibal").value;
        var note = document.getElementById("resolveDesc").value;

        const fileInput     = document.getElementById('resolveFile');
        const file          = fileInput?.files?.[0];

        const fd = new FormData();
        fd.append('report_id', report_id);
        fd.append('proof_image_url', file);
        fd.append('note',  note);

        const headers = {};
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
        const csrfToken  = document.querySelector('meta[name="_csrf"]')?.content;
        if (csrfHeader && csrfToken) headers[csrfHeader] = csrfToken;

        const res = await fetch('/trash/solutionCreate', { method:'POST', body:fd, headers });
        if (!res.ok) throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${res.status}`);
        alert('ì‹ ê³ ê°€ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.');
        window.location.href = '/trash/reportPage';

    }
</script>
</body>
</html>